name: Auto Release

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'

env:
  CARGO_TERM_COLOR: always

jobs:
  check-version:
    name: Check Version Change
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.version_check.outputs.changed }}
      new_version: ${{ steps.version_check.outputs.version }}
      should_release: ${{ steps.version_check.outputs.should_release }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check version change
      id: version_check
      run: |
        # èŽ·å–å½“å‰ç‰ˆæœ¬
        CURRENT_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
        echo "Current version: $CURRENT_VERSION"
        
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ç‰ˆæœ¬çš„tag
        if git tag -l | grep -q "^v$CURRENT_VERSION$"; then
          echo "Tag v$CURRENT_VERSION already exists"
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "should_release=false" >> $GITHUB_OUTPUT
        else
          echo "New version detected: $CURRENT_VERSION"
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "version=v$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "should_release=true" >> $GITHUB_OUTPUT
        fi

  auto-release:
    name: Auto Release
    needs: check-version
    runs-on: ubuntu-latest
    if: needs.check-version.outputs.should_release == 'true'
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Configure cache
      uses: Swatinem/rust-cache@v2

    - name: Run tests
      run: cargo test --verbose

    - name: Build
      run: cargo build --release --verbose

    - name: Create and push tag
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag ${{ needs.check-version.outputs.new_version }}
        git push origin ${{ needs.check-version.outputs.new_version }}

    - name: Generate changelog
      id: changelog
      run: |
        # èŽ·å–ä¸Šä¸€ä¸ªtag
        PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v ${{ needs.check-version.outputs.new_version }} | head -1)
        
        if [ -z "$PREVIOUS_TAG" ]; then
          # å¦‚æžœæ²¡æœ‰ä¹‹å‰çš„tagï¼ŒèŽ·å–æ‰€æœ‰æäº¤
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
        else
          # èŽ·å–ä¸¤ä¸ªtagä¹‹é—´çš„æäº¤
          CHANGELOG=$(git log ${PREVIOUS_TAG}..${{ needs.check-version.outputs.new_version }} --pretty=format:"- %s (%h)" --no-merges)
        fi
        
        # ä¿å­˜changelogåˆ°æ–‡ä»¶
        echo "## ðŸš€ RTK (Rust Toolkit) Release ${{ needs.check-version.outputs.new_version }}" > changelog.md
        echo "" >> changelog.md
        echo "### ðŸ“¦ ä¸‹è½½" >> changelog.md
        echo "" >> changelog.md
        echo "é€‰æ‹©é€‚åˆä½ æ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬ï¼š" >> changelog.md
        echo "" >> changelog.md
        echo "- **Linux (x86_64)**: \`rtk-linux-x86_64.tar.gz\`" >> changelog.md
        echo "- **macOS (x86_64)**: \`rtk-macos-x86_64.tar.gz\`" >> changelog.md
        echo "- **macOS (ARM64)**: \`rtk-macos-aarch64.tar.gz\`" >> changelog.md
        echo "- **Windows (x86_64)**: \`rtk-windows-x86_64.zip\`" >> changelog.md
        echo "" >> changelog.md
        echo "### ðŸ› ï¸ å®‰è£…æ–¹æ³•" >> changelog.md
        echo "" >> changelog.md
        echo "#### Linux/macOS" >> changelog.md
        echo "\`\`\`bash" >> changelog.md
        echo "# ä¸‹è½½å¹¶è§£åŽ‹" >> changelog.md
        echo "tar -xzf rtk-*.tar.gz" >> changelog.md
        echo "" >> changelog.md
        echo "# ç§»åŠ¨åˆ°ç³»ç»Ÿè·¯å¾„ï¼ˆå¯é€‰ï¼‰" >> changelog.md
        echo "sudo mv rtk /usr/local/bin/" >> changelog.md
        echo "" >> changelog.md
        echo "# éªŒè¯å®‰è£…" >> changelog.md
        echo "rtk --version" >> changelog.md
        echo "\`\`\`" >> changelog.md
        echo "" >> changelog.md
        echo "#### Windows" >> changelog.md
        echo "\`\`\`powershell" >> changelog.md
        echo "# è§£åŽ‹ zip æ–‡ä»¶" >> changelog.md
        echo "# å°† rtk.exe æ·»åŠ åˆ° PATH çŽ¯å¢ƒå˜é‡" >> changelog.md
        echo "# æˆ–ç›´æŽ¥è¿è¡Œ" >> changelog.md
        echo ".\\rtk.exe --version" >> changelog.md
        echo "\`\`\`" >> changelog.md
        echo "" >> changelog.md
        echo "### âœ¨ ä¸»è¦åŠŸèƒ½" >> changelog.md
        echo "" >> changelog.md
        echo "- ðŸ” **æ–‡ä»¶æ“ä½œ**: æœç´¢ã€ç»Ÿè®¡ã€é‡å‘½åã€é‡å¤æ£€æµ‹" >> changelog.md
        echo "- ðŸ’» **ç³»ç»Ÿä¿¡æ¯**: ç³»ç»Ÿç›‘æŽ§ã€è¿›ç¨‹ç®¡ç†ã€èµ„æºç»Ÿè®¡" >> changelog.md
        echo "- ðŸŒ **ç½‘ç»œå·¥å…·**: HTTPè¯·æ±‚ã€ç«¯å£æ‰«æã€DNSæŸ¥è¯¢" >> changelog.md
        echo "- ðŸ“ **æ–‡æœ¬å¤„ç†**: æœç´¢ã€æ›¿æ¢ã€ç»Ÿè®¡ã€æŽ’åº" >> changelog.md
        echo "- ðŸ” **åŠ å¯†å·¥å…·**: å“ˆå¸Œè®¡ç®—ã€å¯†ç ç”Ÿæˆã€ç¼–ç è§£ç " >> changelog.md
        echo "- ðŸ•¸ï¸ **Webå®‰å…¨**: ç›®å½•æ‰«æã€æ¼æ´žæ£€æµ‹ã€ä¿¡æ¯æ”¶é›†" >> changelog.md
        echo "" >> changelog.md
        
        if [ ! -z "$CHANGELOG" ]; then
          echo "### ðŸ“ æ›´æ–°å†…å®¹" >> changelog.md
          echo "" >> changelog.md
          echo "$CHANGELOG" >> changelog.md
          echo "" >> changelog.md
        fi
        
        echo "### ðŸ“– ä½¿ç”¨æŒ‡å—" >> changelog.md
        echo "" >> changelog.md
        echo "\`\`\`bash" >> changelog.md
        echo "# äº¤äº’å¼æ¨¡å¼" >> changelog.md
        echo "rtk" >> changelog.md
        echo "" >> changelog.md
        echo "# ç›´æŽ¥å‘½ä»¤æ¨¡å¼" >> changelog.md
        echo "rtk system info" >> changelog.md
        echo "rtk network scan 192.168.1.1" >> changelog.md
        echo "rtk crypto password --length 20" >> changelog.md
        echo "\`\`\`" >> changelog.md
        echo "" >> changelog.md
        echo "æ›´å¤šè¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹ [README.md](https://github.com/zhuima/rtk/blob/main/README.md)" >> changelog.md

    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ needs.check-version.outputs.new_version }}
        release_name: Release ${{ needs.check-version.outputs.new_version }}
        body_path: changelog.md
        draft: false
        prerelease: false

  trigger-build:
    name: Trigger Build Release
    needs: [check-version, auto-release]
    runs-on: ubuntu-latest
    if: needs.check-version.outputs.should_release == 'true'
    steps:
    - name: Trigger release workflow
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'release.yml',
            ref: 'main',
            inputs: {
              tag: '${{ needs.check-version.outputs.new_version }}'
            }
          });